generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = "file:./dev.db"
}

model Citizen {
  id                   String            @id @default(cuid())
  phoneNumberEncrypted String            @unique
  phoneNumberHash      String            @unique
  emailEncrypted       String?
  emailHash            String?
  name                 String?
  isPhoneVerified      Boolean           @default(false)
  isIdentityVerified   Boolean           @default(false)
  totalPoints          Int               @default(0)
  pointsEarned         Int               @default(0)
  pointsRedeemed       Int               @default(0)
  reportsSubmitted     Int               @default(0)
  reportsApproved      Int               @default(0)
  accuracyRate         Float             @default(0.0)
  isAnonymousMode      Boolean           @default(false)
  notificationEnabled  Boolean           @default(true)
  createdAt            DateTime          @default(now())
  updatedAt            DateTime          @updatedAt
  lastLoginAt          DateTime?
  isActive             Boolean           @default(true)
  reports              ViolationReport[]
  feedback             Feedback[]
  pointsTransactions   PointsTransaction[]
  reportEvents         ReportEvent[]
  notifications        Notification[]

  @@index([phoneNumberHash])
  @@index([emailHash])
}

model Police {
  id              String            @id @default(cuid())
  emailEncrypted  String            @unique
  emailHash       String            @unique
  passwordHash    String
  name            String
  role            String
  department      String
  city            String
  district        String
  badgeNumber     String            @unique
  isActive        Boolean           @default(true)
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt
  lastLoginAt     DateTime?
  reviewedReports ViolationReport[]
  feedback        Feedback[]
  assignedFeedback Feedback[] @relation("AssignedFeedback")
  feedbackResponses FeedbackResponse[]
  reportEvents     ReportEvent[]
  reportComments   ReportComment[]

  @@index([emailHash])
  @@index([badgeNumber])
  @@map("User")
}

model ViolationReport {
  id                     Int       @id @default(autoincrement())
  reporterId             String
  reporterPhoneEncrypted String
  reporterPhoneHash      String
  reporterCity           String
  reporterPincode        String
  violationType          String
  severity               String?
  description            String?
  timestamp              DateTime
  latitude               Float
  longitude              Float
  addressEncrypted       String
  pincode                String
  city                   String
  district               String
  state                  String
  vehicleNumberEncrypted String?
  vehicleType            String?
  vehicleColor           String?
  photoUrl               String?
  videoUrl               String?
  mediaMetadata          String?
  status                 String    @default("PENDING")
  isDuplicate            Boolean   @default(false)
  duplicateGroupId       String?
  confidenceScore        Float?
  reviewerId             String?
  reviewTimestamp        DateTime?
  reviewNotes            String?
  challanIssued          Boolean   @default(false)
  challanNumber          String?
  pointsAwarded          Int       @default(0)
  isFirstReporter        Boolean   @default(false)
  createdAt              DateTime  @default(now())
  updatedAt              DateTime  @updatedAt
  isAnonymous            Boolean   @default(false)
  citizenId              String
  reviewer               Police?     @relation(fields: [reviewerId], references: [id])
  citizen                Citizen   @relation(fields: [citizenId], references: [id])
  feedback               Feedback[]
  events                 ReportEvent[]
  comments               ReportComment[]

  @@index([status])
  @@index([city])
  @@index([violationType])
  @@index([createdAt])
  @@index([citizenId])
  @@index([reporterPhoneHash])
}

model OTP {
  id                   String   @id @default(cuid())
  phoneNumberEncrypted String
  phoneNumberHash      String
  otp                  String
  expiresAt            DateTime
  isUsed               Boolean  @default(false)
  createdAt            DateTime @default(now())

  @@index([phoneNumberHash])
  @@index([expiresAt])
}

model Feedback {
  id                String        @id @default(cuid())
  feedbackType      String        // APP_FEEDBACK, REPORT_FEEDBACK, SERVICE_FEEDBACK, FEATURE_REQUEST
  category          String        // UI_UX, BUG, PERFORMANCE, SUGGESTION, COMPLAINT, PRAISE
  title             String
  description       String
  rating            Int?          // 1-5 rating (optional)
  priority          String        // LOW, MEDIUM, HIGH, CRITICAL
  status            String        @default("PENDING") // PENDING, IN_REVIEW, RESOLVED, CLOSED
  isAnonymous       Boolean       @default(false)
  contactEmail      String?       // For follow-up
  contactPhone      String?       // For follow-up
  attachments       String?       // JSON array of file URLs
  metadata          String?       // JSON for additional data
  assignedTo        String?       // User ID of assigned reviewer
  resolutionNotes   String?
  resolvedAt        DateTime?
  createdAt         DateTime      @default(now())
  updatedAt         DateTime      @updatedAt
  
  // Relationships
  citizenId         String?       // If feedback from citizen
  userId            String?       // If feedback from police user
  reportId          Int?          // If feedback related to specific report
  
  citizen           Citizen?      @relation(fields: [citizenId], references: [id])
  user              Police?         @relation(fields: [userId], references: [id])
  report            ViolationReport? @relation(fields: [reportId], references: [id])
  assignedUser      Police?         @relation("AssignedFeedback", fields: [assignedTo], references: [id])
  responses         FeedbackResponse[]

  @@index([feedbackType])
  @@index([category])
  @@index([status])
  @@index([priority])
  @@index([createdAt])
  @@index([citizenId])
  @@index([userId])
  @@index([reportId])
  @@index([assignedTo])
}

model FeedbackResponse {
  id          String   @id @default(cuid())
  feedbackId  String
  responderId String   // User ID of police responder
  message     String
  isInternal  Boolean  @default(false) // Internal note vs public response
  createdAt   DateTime @default(now())
  
  // Relationships
  feedback    Feedback @relation(fields: [feedbackId], references: [id], onDelete: Cascade)
  responder   Police     @relation(fields: [responderId], references: [id])

  @@index([feedbackId])
  @@index([responderId])
  @@index([createdAt])
}

model ReportEvent {
  id          String   @id @default(cuid())
  reportId    Int
  citizenId   String?
  userId      String?
  type        String   // REPORT_SUBMITTED | STATUS_UPDATED | POINTS_AWARDED | FEEDBACK_ADDED | MEDIA_UPLOADED
  title       String?
  description String?
  metadata    String?
  createdAt   DateTime @default(now())

  report      ViolationReport @relation(fields: [reportId], references: [id], onDelete: Cascade)
  citizen     Citizen?        @relation(fields: [citizenId], references: [id])
  user        Police?         @relation(fields: [userId], references: [id])

  @@index([reportId, createdAt])
  @@index([citizenId, createdAt])
  @@index([userId, createdAt])
}

model ReportComment {
  id         String   @id @default(cuid())
  reportId   Int
  authorId   String?
  authorName String?
  message    String
  isInternal Boolean  @default(false)
  createdAt  DateTime @default(now())

  report     ViolationReport @relation(fields: [reportId], references: [id], onDelete: Cascade)
  author     Police?         @relation(fields: [authorId], references: [id])

  @@index([reportId, createdAt])
  @@index([authorId, createdAt])
}

model PointsTransaction {
  id           String   @id @default(cuid())
  citizenId    String
  type         String   // EARN | REDEEM | ADJUST
  reportId     Int?
  points       Int      // positive for EARN/ADJUST add; negative for REDEEM/ADJUST subtract
  description  String?
  metadata     String?
  balanceAfter Int
  createdAt    DateTime @default(now())

  citizen      Citizen  @relation(fields: [citizenId], references: [id])

  @@index([citizenId, createdAt])
  @@index([reportId])
}

model Notification {
  id         String   @id @default(cuid())
  citizenId  String
  reportId   Int?
  type       String   // REPORT_STATUS
  title      String
  message    String
  readAt     DateTime?
  expiresAt  DateTime?
  createdAt  DateTime @default(now())

  citizen    Citizen  @relation(fields: [citizenId], references: [id])

  @@index([citizenId, createdAt])
  @@index([reportId])
}
